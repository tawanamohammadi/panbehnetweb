# راهنمای استقرار و به‌روزرسانی پنبه VPN

این راهنما شما را قدم به قدم برای استقرار و به‌روزرسانی اپلیکیشن پنبه VPN با استفاده از یک معماری مدرن و حرفه‌ای راهنمایی می‌کند.

## معماری پروژه

- **باطن (Backend):**
  - **وردپرس بی‌سر (Headless):** روی ساب‌دامین `admin.cinemapluss.ir` برای مدیریت آسان محتوا (وبلاگ، نظرات و...).
  - **سرور Node.js (Express):** روی دامنه اصلی اجرا می‌شود و به عنوان پروکسی امن برای APIهای Marzban و وردپرس عمل می‌کند.
- **ظاهر (Frontend):** اپلیکیشن React که روی دامنه اصلی `cinemapluss.ir` توسط Nginx سرو می‌شود و محتوای داینامیک را از APIها دریافت می‌کند.

---

## بخش اول: استقرار اولیه (Initial Deployment)

اگر برای اولین بار پروژه را مستقر می‌کنید، مراحل کامل نصب وردپرس و React را از نسخه‌های قبلی این راهنما دنبال کنید. این بخش‌ها شامل نصب پشته LEMP، پیکربندی دیتابیس، نصب وردپرس، و تنظیمات Nginx برای هر دو سایت است.

**نکته کلیدی:** به جای `git clone` برای اولین بار، شما باید پروژه را روی سرور خود ایجاد کرده و سپس محتوای آن را از گیت‌هاب دریافت کنید.

---

## بخش دوم: دستورالعمل به‌روزرسانی سایت (Deployment Workflow)

این فرآیند استاندارد به شما کمک می‌کند تا هر بار با اطمینان کامل، سایت خود را پس از اعمال تغییرات در کد، به‌روز کنید. **به جای `git clone` در هر آپدیت، باید از `git pull` استفاده کنید.**

#### **مرحله ۱: ارسال تغییرات به گیت‌هاب**

پس از اینکه تغییرات خود را در کامپیوتر شخصی (`localhost`) تست کردید، آن‌ها را به ریپازیتوری گیت‌هاب خود ارسال کنید:

```bash
# فایل‌های تغییر کرده را اضافه کنید
git add .

# تغییرات را با یک پیام مناسب ثبت کنید
git commit -m "پیام توضیحات آپدیت شما"

# به شعبه اصلی (main) ارسال کنید
git push origin main
```

#### **مرحله ۲: اتصال به سرور و به‌روزرسانی**

با استفاده از ترمینال، به سرور خود متصل شوید:
```bash
ssh [your_username]@[your_server_ip]
```

سپس دستورات زیر را به ترتیب اجرا کنید:

```bash
# به پوشه پروژه خود بروید (جایی که اولین بار پروژه را کلون کردید)
cd /var/www/panbeh-react

# ۱. آخرین تغییرات را از گیت‌هاب دریافت کنید
# این دستور بسیار سریع‌تر و بهینه‌تر از clone مجدد است
git pull origin main

# ۲. وابستگی‌ها را مجدداً نصب کنید (برای اطمینان از هماهنگی پکیج‌ها)
npm install

# ۳. پروژه را مجدداً بیلد کنید (این مرحله حیاتی و کلیدی است!)
# این دستور فایل‌های بهینه‌سازی شده، فشرده و کد-اسپلیت شده را در پوشه `dist/` می‌سازد.
# عدم اجرای این دستور باعث می‌شود سایت با سرعت پایین و بدون بهینه‌سازی اجرا شود و امتیاز عملکرد شما به شدت افت کند.
npm run build
```
با اجرای موفق `npm run build`، وب سرور Nginx به طور خودکار شروع به سرو کردن نسخه جدید و سریع سایت شما می‌کند.

#### **مرحله ۳: راه‌اندازی مجدد سرور Node.js (فقط در صورت تغییر در `server.js`)**

اگر فایلی به جز کامپوننت‌های React (مانند `server.js` یا `package.json`) را تغییر داده‌اید، باید سرور Node.js را هم ری‌استارت کنید. برای مدیریت حرفه‌ای و پایدار سرور، استفاده از ابزار **PM2** به شدت توصیه می‌شود.

**نصب و راه‌اندازی اولیه PM2 (فقط یک بار انجام می‌شود):**
```bash
# نصب PM2 به صورت سراسری روی سرور
sudo npm install pm2 -g

# اجرای اولیه سرور با PM2 (مطمئن شوید در پوشه پروژه هستید)
# این دستور سرور شما را در پس‌زمینه اجرا و مدیریت می‌کند
pm2 start server.js --name panbeh-app

# ذخیره لیست فرآیندها تا پس از ریبوت سرور، برنامه خودکار اجرا شود
pm2 save
```

**دستورالعمل ری‌استارت در هر آپدیت:**
از این به بعد، هر بار که `server.js` را آپدیت کردید، کافیست دستور زیر را اجرا کنید:
```bash
# ری‌استارت کردن اپلیکیشن با PM2 بدون قطعی
pm2 restart panbeh-app
```

`PM2` به طور خودکار برنامه شما را مدیریت می‌کند و در صورت بروز خطا، آن را مجدداً راه‌اندازی می‌کند.

#### **مرحله ۴: بررسی نهایی**

مرورگر خود را باز کرده، حافظه کش (Cache) را پاک کنید (با `Ctrl + Shift + R` یا `Cmd + Shift + R`) و سایت را مجدداً بررسی کنید. سپس یک بار دیگر تست PageSpeed Insights را اجرا کنید تا از اعمال شدن بهینه‌سازی‌ها و بازگشت امتیاز به ۱۰۰ مطمئن شوید.